<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
  
<mapper namespace="inventory">
    <!-- 인벤토리 시퀀스 값 조회 -->
    <select id="sequence" resultType="int">
        SELECT seq_inventory.nextval FROM dual
    </select>

    <!-- 인벤토리 아이템 추가 -->
    <insert id="insert">
        INSERT INTO INVENTORY (
            inventory_no,
            inventory_member_id,
            inventory_item_no,
            inventory_equipped
        )
        VALUES (
            seq_inventory.nextval,
            #{inventoryMemberId},
            #{inventoryItemNo},
            'N'
        )
    </insert>

    <!-- 인벤토리 정보 수정 (수량, 장착 여부) -->
    <update id="update">
        UPDATE INVENTORY
        SET
            inventory_quantity = #{inventoryQuantity},
            inventory_equipped = #{inventoryEquipped}
        WHERE inventory_no = #{inventoryNo}
    </update>

    <!-- 인벤토리 단건 조회 -->
    <select id="selectOne" resultType="InventoryDto">
        SELECT 
            inventory_no           AS inventoryNo,
            inventory_member_id    AS inventoryMemberId,
            inventory_item_no      AS inventoryItemNo,
            inventory_created_at   AS inventoryCreatedAt,
            inventory_quantity     AS inventoryQuantity,
            inventory_equipped     AS inventoryEquipped
        FROM INVENTORY
        WHERE inventory_no = #{inventoryNo}
    </select>

    <!-- 회원별 인벤토리 목록 조회 -->
    <select id="selectList" resultType="InventoryDto">
        SELECT 
            inventory_no           AS inventoryNo,
            inventory_member_id    AS inventoryMemberId,
            inventory_item_no      AS inventoryItemNo,
            inventory_created_at   AS inventoryCreatedAt,
            inventory_quantity     AS inventoryQuantity,
            inventory_equipped     AS inventoryEquipped
        FROM INVENTORY
        WHERE inventory_member_id = #{inventoryMemberId}
        ORDER BY inventory_no DESC
    </select>

    <!-- 회원 인벤토리 + 아이템 정보 조회 (마이페이지용) -->
    <select id="selectListByMemberId" resultType="InventoryDto">
        SELECT 
            I.INVENTORY_NO          AS inventoryNo,
            I.INVENTORY_MEMBER_ID   AS inventoryMemberId,
            I.INVENTORY_ITEM_NO     AS inventoryItemNo,
            I.INVENTORY_CREATED_AT  AS inventoryCreatedAt,
            I.INVENTORY_QUANTITY    AS inventoryQuantity,
            I.INVENTORY_EQUIPPED    AS inventoryEquipped,

            P.POINT_ITEM_NAME       AS pointItemName,
            P.POINT_ITEM_SRC        AS pointItemSrc,
            P.POINT_ITEM_TYPE       AS pointItemType,
            P.POINT_ITEM_CONTENT    AS pointItemContent
        FROM INVENTORY I
        JOIN POINT_ITEM_STORE P 
            ON I.INVENTORY_ITEM_NO = P.POINT_ITEM_NO
        WHERE I.INVENTORY_MEMBER_ID = #{loginId}
        ORDER BY I.INVENTORY_CREATED_AT DESC
    </select>

    <!-- 인벤토리 아이템 삭제 -->
    <delete id="delete">
        DELETE FROM INVENTORY
        WHERE inventory_no = #{inventoryNo}
    </delete>

    <!-- 관리자용 회원 인벤토리 조회 -->
    <select id="selectListByAdmin" resultType="InventoryDto">
        SELECT 
            I.INVENTORY_NO          AS inventoryNo,
            I.INVENTORY_MEMBER_ID   AS inventoryMemberId,
            I.INVENTORY_ITEM_NO     AS inventoryItemNo,
            I.INVENTORY_CREATED_AT  AS inventoryCreatedAt,
            I.INVENTORY_EQUIPPED    AS inventoryEquipped,
            I.INVENTORY_QUANTITY    AS inventoryQuantity,
            P.POINT_ITEM_NAME       AS pointItemName,
            P.POINT_ITEM_SRC        AS pointItemSrc,
            P.POINT_ITEM_TYPE       AS pointItemType
        FROM INVENTORY I
        LEFT OUTER JOIN POINT_ITEM_STORE P 
            ON I.INVENTORY_ITEM_NO = P.POINT_ITEM_NO
        JOIN MEMBER M 
            ON I.INVENTORY_MEMBER_ID = M.MEMBER_ID
        WHERE I.INVENTORY_MEMBER_ID = #{memberId}
          AND M.MEMBER_LEVEL != '관리자'
        ORDER BY I.INVENTORY_CREATED_AT DESC
    </select>

    <!-- 회원 + 아이템 기준 인벤토리 조회 -->
    <select id="selectOneByMemberAndItem" resultType="InventoryDto">
        SELECT 
            INVENTORY_NO          AS inventoryNo,
            INVENTORY_MEMBER_ID   AS inventoryMemberId,
            INVENTORY_ITEM_NO     AS inventoryItemNo,
            INVENTORY_QUANTITY    AS inventoryQuantity,
            INVENTORY_CREATED_AT  AS inventoryCreatedAt,
            INVENTORY_EQUIPPED    AS inventoryEquipped
        FROM INVENTORY
        WHERE INVENTORY_MEMBER_ID = #{inventoryMemberId}
          AND INVENTORY_ITEM_NO = #{inventoryItemNo}
    </select>

    <!-- 같은 타입 아이템 장착 해제 -->
    <update id="unequipByType">
        UPDATE INVENTORY
        SET inventory_equipped = 'N'
        WHERE inventory_member_id = #{memberId}
          AND inventory_item_no IN (
              SELECT point_item_no
              FROM point_item_store
              WHERE point_item_type = #{type}
          )
    </update>

    <!-- 관리자용 회원 목록 조회 (페이징) -->
    <select id="fetchAdminMemberList" resultType="MemberDto">
        SELECT * FROM (
            SELECT rownum rn, tmp.* FROM (
                SELECT * FROM member
                <where>
                    <if test="keyword != null and keyword != ''">
                        (member_id LIKE '%' || #{keyword} || '%'
                         OR member_nickname LIKE '%' || #{keyword} || '%')
                    </if>
                    AND member_level != '관리자'
                </where>
                ORDER BY member_id ASC
            ) tmp
        )
        WHERE rn BETWEEN #{startRow} AND #{endRow}
    </select>

    <!-- 관리자용 회원 수 조회 -->
    <select id="countAdminMembers" resultType="int">
        SELECT COUNT(*)
        FROM member
        <where>
            <if test="keyword != null and keyword != ''">
                (member_id LIKE '%' || #{keyword} || '%'
                 OR member_nickname LIKE '%' || #{keyword} || '%')
            </if>
            AND member_level != '관리자'
        </where>
    </select>

</mapper>