<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="dailyquest">


<!-- 오늘 날짜 기준 퀘스트 진행 로그 조회 -->
<select id="selectTodayLogs" resultType="map">
    SELECT 
        POINT_GET_QUEST_TYPE      AS "type",      -- 퀘스트 유형
        POINT_GET_QUEST_COUNT     AS "count",     -- 오늘 진행 횟수
        POINT_GET_QUEST_REWARD_YN AS "rewardYn"   -- 보상 수령 여부
    FROM POINT_GET_QUEST_LOG
    WHERE POINT_GET_QUEST_MEMBER_ID = #{memberId}
      -- 날짜는 YYYYMMDD 문자열 기준으로 비교
      AND TO_CHAR(POINT_GET_QUEST_DATE, 'YYYYMMDD') = #{date}
</select>

<!-- 퀘스트 로그 upsert (있으면 count 증가, 없으면 신규 생성) -->
<update id="upsertQuestLog">
    MERGE INTO POINT_GET_QUEST_LOG L
    USING DUAL
       ON (
           L.POINT_GET_QUEST_MEMBER_ID = #{memberId}
           AND L.POINT_GET_QUEST_TYPE = #{type}
           -- 동일 날짜 퀘스트 여부 확인
           AND TO_CHAR(L.POINT_GET_QUEST_DATE, 'YYYYMMDD') = #{date}
       )
    WHEN MATCHED THEN
        -- 이미 로그가 있으면 횟수 +1
        UPDATE SET 
            L.POINT_GET_QUEST_COUNT = L.POINT_GET_QUEST_COUNT + 1
    WHEN NOT MATCHED THEN
        -- 로그가 없으면 최초 생성
        INSERT (
            POINT_GET_QUEST_LOG_ID,
            POINT_GET_QUEST_MEMBER_ID,
            POINT_GET_QUEST_TYPE,
            POINT_GET_QUEST_DATE,
            POINT_GET_QUEST_COUNT,
            POINT_GET_QUEST_REWARD_YN,
            POINT_GET_QUEST_CREATED_AT
        ) VALUES (
            seq_point_get_quest_log.nextval,
            #{memberId},
            #{type},
            TO_DATE(#{date}, 'YYYYMMDD'), -- 문자열 날짜를 DATE로 변환
            1,                             -- 최초 1회 수행
            'N',                           -- 보상 미수령 상태
            SYSTIMESTAMP
        )
</update>

<!-- 퀘스트 보상 수령 처리 -->
<update id="updateRewardStatus">
    UPDATE POINT_GET_QUEST_LOG
    SET POINT_GET_QUEST_REWARD_YN = 'Y' -- 보상 수령 완료
    WHERE POINT_GET_QUEST_MEMBER_ID = #{memberId}
      AND POINT_GET_QUEST_TYPE = #{type}
      AND TO_CHAR(POINT_GET_QUEST_DATE, 'YYYYMMDD') = #{date}
      AND POINT_GET_QUEST_REWARD_YN = 'N' -- 이미 받은 경우 중복 처리 방지
</update>


</mapper>