<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="memberIcon">

    <!-- 회원이 보유한 아이콘 목록 조회 -->
    <select id="selectMyIcons" resultType="MemberIconDto">
        SELECT 
            MI.MEMBER_ICONS_ID          AS memberIconId,
            MI.MEMBER_ICONS_MEMBER_ID   AS memberId,
            MI.MEMBER_ICONS_ICON_ID     AS iconId,
            MI.MEMBER_ICONS_OBTAIN_TIME AS memberIconObtainTime,
            MI.IS_EQUIPPED              AS isEquipped,

            I.ICON_NAME                 AS iconName,
            I.ICON_RARITY               AS iconRarity,
            I.ICON_SRC                  AS iconSrc
        FROM MEMBER_ICONS MI
        JOIN ICON I 
            ON MI.MEMBER_ICONS_ICON_ID = I.ICON_ID
        WHERE MI.MEMBER_ICONS_MEMBER_ID = #{memberId}
        ORDER BY 
            CASE I.ICON_RARITY
                WHEN 'LEGENDARY' THEN 1
                WHEN 'UNIQUE'    THEN 2
                WHEN 'EPIC'      THEN 3
                WHEN 'RARE'      THEN 4
                WHEN 'COMMON'    THEN 5
                WHEN 'EVENT'     THEN 6
                ELSE 7
            END ASC,
            MI.MEMBER_ICONS_OBTAIN_TIME DESC
    </select>

    <!-- 회원이 이미 아이콘을 보유하고 있는지 확인 -->
    <select id="checkUserHasIcon" resultType="int">
        SELECT COUNT(*)
        FROM MEMBER_ICONS
        WHERE MEMBER_ICONS_MEMBER_ID = #{memberId}
          AND MEMBER_ICONS_ICON_ID = #{iconId}
    </select>

    <!-- 회원 아이콘 지급 -->
    <insert id="insertMemberIcon">
        INSERT INTO MEMBER_ICONS (
            MEMBER_ICONS_ID,
            MEMBER_ICONS_MEMBER_ID,
            MEMBER_ICONS_ICON_ID,
            MEMBER_ICONS_OBTAIN_TIME
        )
        VALUES (
            seq_member_icons.nextval,
            #{memberId},
            #{iconId},
            SYSTIMESTAMP
        )
    </insert>

    <!-- 회원 아이콘 전체 장착 해제 -->
    <update id="unequipAllIcons">
        UPDATE MEMBER_ICONS
        SET IS_EQUIPPED = 'N'
        WHERE MEMBER_ICONS_MEMBER_ID = #{memberId}
    </update>

    <!-- 선택한 아이콘 장착 -->
    <update id="equipIcon">
        UPDATE MEMBER_ICONS
        SET IS_EQUIPPED = 'Y'
        WHERE MEMBER_ICONS_MEMBER_ID = #{memberId}
          AND MEMBER_ICONS_ICON_ID = #{iconId}
    </update>

    <!-- 현재 장착된 아이콘 이미지 조회 -->
    <select id="selectEquippedIconSrc" resultType="string">
        SELECT I.ICON_SRC
        FROM MEMBER_ICONS MI
        JOIN ICON I 
            ON MI.MEMBER_ICONS_ICON_ID = I.ICON_ID
        WHERE MI.MEMBER_ICONS_MEMBER_ID = #{memberId}
          AND MI.IS_EQUIPPED = 'Y'
          AND ROWNUM &lt;= 1
    </select>

    <!-- 장착된 프레임 스타일 조회 -->
    <select id="selectEquippedFrameStyle" resultType="string">
        SELECT B.point_item_content
        FROM inventory A
        JOIN point_item_store B 
            ON A.inventory_item_no = B.point_item_no
        WHERE A.inventory_member_id = #{memberId}
          AND A.inventory_equipped = 'Y'
          AND B.point_item_type = 'DECO_FRAME'
    </select>

    <!-- 장착된 배경 스타일 조회 -->
    <select id="selectEquippedBgStyle" resultType="string">
        SELECT B.point_item_src
        FROM inventory A
        JOIN point_item_store B 
            ON A.inventory_item_no = B.point_item_no
        WHERE A.inventory_member_id = #{memberId}
          AND A.inventory_equipped = 'Y'
          AND B.point_item_type = 'DECO_BG'
    </select>

    <!-- 장착된 닉네임 스타일 조회 -->
    <select id="selectEquippedNickStyle" resultType="string">
        SELECT B.point_item_content
        FROM inventory A
        JOIN point_item_store B 
            ON A.inventory_item_no = B.point_item_no
        WHERE A.inventory_member_id = #{memberId}
          AND A.inventory_equipped = 'Y'
          AND B.point_item_type = 'DECO_NICK'
    </select>

    <!-- 동일 타입 아이템 전체 장착 해제 -->
    <update id="unequipAllItemsByType">
        UPDATE INVENTORY
        SET INVENTORY_EQUIPPED = 'N'
        WHERE INVENTORY_MEMBER_ID = #{memberId}
          AND INVENTORY_ITEM_NO IN (
              SELECT POINT_ITEM_NO
              FROM POINT_ITEM
              WHERE POINT_ITEM_TYPE = #{itemType}
          )
    </update>

    <!-- 인벤토리 아이템 장착 -->
    <update id="equipItem">
        UPDATE INVENTORY
        SET INVENTORY_EQUIPPED = 'Y'
        WHERE INVENTORY_NO = #{inventoryNo}
    </update>

    <!-- 특정 회원 아이콘 조회 (관리자 제외) -->
    <select id="selectUserIconsDetail"
            resultType="MemberIconDto">
        SELECT 
            MI.MEMBER_ICONS_ID          AS memberIconId,
            MI.MEMBER_ICONS_MEMBER_ID   AS memberId,
            MI.MEMBER_ICONS_ICON_ID     AS iconId,
            MI.MEMBER_ICONS_OBTAIN_TIME AS memberIconObtainTime,
            MI.IS_EQUIPPED              AS isEquipped,
            I.ICON_NAME                 AS iconName,
            I.ICON_RARITY               AS iconRarity,
            I.ICON_SRC                  AS iconSrc
        FROM MEMBER_ICONS MI
        JOIN ICON I 
            ON MI.MEMBER_ICONS_ICON_ID = I.ICON_ID
        JOIN MEMBER M 
            ON MI.MEMBER_ICONS_MEMBER_ID = M.MEMBER_ID
        WHERE MI.MEMBER_ICONS_MEMBER_ID = #{memberId}
          AND M.MEMBER_LEVEL != '관리자'
    </select>

    <!-- 회원 아이콘 회수 -->
    <delete id="deleteMemberIcon">
        DELETE FROM MEMBER_ICONS
        WHERE MEMBER_ICONS_ID = #{memberIconId}
    </delete>

    <!-- 아이콘 마스터 목록 조회 -->
    <select id="selectIconList" resultType="IconDto">
        SELECT *
        FROM ICON
    </select>

</mapper>