<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
  
<mapper namespace="pointhistory">

<!-- 포인트 이력 등록 -->
<insert id="insert">
    INSERT INTO point_history (
        point_history_id,
        point_history_member_id,
        point_history_amount,
        point_history_trx_type,
        point_history_reason
    )
    VALUES (
        seq_point_history.nextval,
        #{pointHistoryMemberId},
        #{pointHistoryAmount},
        #{pointHistoryTrxType},
        #{pointHistoryReason}
    )
</insert>

<!-- 회원별 포인트 이력 전체 조회 -->
<select id="selectListByMemberId" resultType="PointHistoryDto">
    SELECT
        point_history_id          AS pointHistoryId,
        point_history_member_id   AS pointHistoryMemberId,
        point_history_amount      AS pointHistoryAmount,
        point_history_trx_type    AS pointHistoryTrxType,
        point_history_reason      AS pointHistoryReason,
        point_history_created_at  AS pointHistoryCreatedAt
    FROM point_history
    WHERE point_history_member_id = #{memberId}
    ORDER BY point_history_id DESC
</select>

<!-- 포인트 이력 단건 조회 -->
<select id="selectOne" resultType="PointHistoryDto">
    SELECT
        point_history_id          AS pointHistoryId,
        point_history_member_id   AS pointHistoryMemberId,
        point_history_amount      AS pointHistoryAmount,
        point_history_trx_type    AS pointHistoryTrxType,
        point_history_reason      AS pointHistoryReason,
        point_history_created_at  AS pointHistoryCreatedAt
    FROM point_history
    WHERE point_history_id = #{pointHistoryId}
</select>

<!-- 포인트 이력 수정 (관리자용) -->
<update id="update">
    UPDATE point_history
    SET
        point_history_trx_type = #{pointHistoryTrxType},
        point_history_amount   = #{pointHistoryAmount},
        point_history_reason   = #{pointHistoryReason}
    WHERE point_history_id = #{pointHistoryId}
</update>

<!-- 회원별 포인트 이력 페이징 조회 + 유형별 필터 -->
<select id="selectListByMemberIdPaging" resultType="PointHistoryDto">
    SELECT *
    FROM (
        SELECT TMP.*, ROWNUM RN
        FROM (
            SELECT
                point_history_id         AS pointHistoryId,
                point_history_member_id  AS pointHistoryMemberId,
                point_history_amount     AS pointHistoryAmount,
                point_history_trx_type   AS pointHistoryTrxType,
                point_history_reason     AS pointHistoryReason,
                point_history_created_at AS pointHistoryCreatedAt
            FROM point_history
            WHERE point_history_member_id = #{memberId}
            <choose>
                <!-- 적립 -->
                <when test="type == 'earn'">
                    AND point_history_amount &gt; 0
                </when>
                <!-- 사용 -->
                <when test="type == 'use'">
                    AND point_history_amount &lt; 0
                </when>
                <!-- 아이템 관련 (금액 없음) -->
                <when test="type == 'item'">
                    AND point_history_amount = 0
                </when>
            </choose>
            ORDER BY point_history_id DESC
        ) TMP
    )
    WHERE RN BETWEEN #{startRow} AND #{endRow}
</select>

<!-- 포인트 이력 개수 조회 (유형별) -->
<select id="countHistory" resultType="int">
    SELECT COUNT(*)
    FROM point_history
    WHERE point_history_member_id = #{memberId}
    <choose>
        <!-- 적립 -->
        <when test="type == 'earn'">
            AND point_history_amount &gt; 0
        </when>
        <!-- 사용 -->
        <when test="type == 'use'">
            AND point_history_amount &lt; 0
        </when>
        <!-- 아이템 -->
        <when test="type == 'item'">
            AND point_history_amount = 0
        </when>
    </choose>
</select>

<!-- 오늘 동일 아이템 구매 횟수 조회 (일일 구매 제한용) -->
<select id="countTodayPurchase" resultType="int">
    SELECT COUNT(*)
    FROM point_history
    WHERE point_history_member_id = #{memberId}
      AND point_history_reason LIKE '%' || #{itemName} || '%'
      AND TRUNC(point_history_created_at) = TRUNC(SYSDATE)
      AND point_history_trx_type = 'USE'
</select>

</mapper>